name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # 1. Linux - GCC Release
          - name: Linux (GCC) Release
            os: ubuntu-latest
            build_type: Release
            cc: gcc
            cxx: g++

          # 2. Linux - GCC Debug
          - name: Linux (GCC) Debug
            os: ubuntu-latest
            build_type: Debug
            cc: gcc
            cxx: g++

          # 3. Linux - Clang Release
          - name: Linux (Clang) Release
            os: ubuntu-latest
            build_type: Release
            cc: clang
            cxx: clang++

          # 4. Windows - MSVC Release
          - name: Windows (MSVC) Release
            os: windows-latest
            build_type: Release
            # Windows ignores CC/CXX env vars; it defaults to Visual Studio

          # 5. macOS - AppleClang Release
          - name: macOS (AppleClang) Release
            os: macos-latest
            build_type: Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure CMake
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }}

    - name: Test with sample data
      shell: bash
      run: |
        # --- 1. Construct Executable Name ---
        EXE_NAME="maratona_score"
        
        # Add 'd' suffix if Debug build (common CMake pattern)
        if [[ "${{ matrix.build_type }}" == "Debug" ]]; then
          EXE_NAME="${EXE_NAME}d"
        fi
        
        # Add .exe extension if Windows
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          EXE_NAME="${EXE_NAME}.exe"
        fi

        # --- 2. Locate the Binary ---
        # Windows often puts binaries in build/bin/Release/
        # Linux usually puts them in build/bin/
        BIN_PATH=$(find build -name "$EXE_NAME" | head -n 1)

        if [ -z "$BIN_PATH" ]; then
          echo "❌ Error: Could not find executable $EXE_NAME"
          exit 1
        fi

        echo "✅ Found executable at: $BIN_PATH"

        # --- 3. Run Test ---
        # We use the found path to execute
        "$BIN_PATH" sample/data/ sample/settings/ ./test_output.csv
        
        if [ -f "./test_output.csv" ]; then
          echo "✅ Test Passed: Sample data processed successfully"
        else
          echo "❌ Test Failed: Output file missing"
          exit 1
        fi

    - name: Upload build artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: maratona-score-${{ matrix.os }}-${{ matrix.cc || 'msvc' }}
        path: |
          build/**/maratona_score*
          build/**/MaratonaScoreLib*