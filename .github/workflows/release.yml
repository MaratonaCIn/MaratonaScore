name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-release:
    name: Build Release for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure CMake
      # Unified configuration step
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      # Unified build step
      run: cmake --build build --config Release

    - name: Package binaries
      shell: bash
      run: |
        mkdir package
        
        # --- 1. Find and Copy Artifacts ---
        # Windows puts binaries in build/bin/Release/, others in build/bin/
        # We look in both places using wildcards to handle .exe, .dll, .so, .dylib
        
        # Try copy from specific Release folder (Windows)
        if [ -d "build/bin/Release" ]; then
          cp build/bin/Release/maratona_score* package/
          cp build/bin/Release/MaratonaScoreLib.* package/
        else
          # Standard copy (Linux/Mac)
          cp build/bin/maratona_score* package/
          cp build/bin/MaratonaScoreLib.* package/
        fi

        # --- 2. Copy Docs ---
        cp LICENSE package/
        cp README.md package/

        # --- 3. Create Tarball ---
        # We create a specific name for the tarball based on the OS and Tag
        TAR_NAME="maratona_score-${{ runner.os }}-${{ github.ref_name }}.tar.gz"
        
        # -C changes directory to 'package' so the tarball doesn't contain the 'package/' folder prefix
        tar -czf "$TAR_NAME" -C package .
        
        echo "ASSET_NAME=$TAR_NAME" >> $GITHUB_ENV

    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        # We name the artifact identically to the tarball to make the download step cleaner
        name: ${{ env.ASSET_NAME }}
        path: ${{ env.ASSET_NAME }}

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        # This looks into the artifacts folder for any tar.gz file
        files: artifacts/**/*.tar.gz
        body: |
          ## MaratonaScore ${{ github.ref_name }}

          ### Downloads
          - **Linux**: `maratona_score-Linux-${{ github.ref_name }}.tar.gz`
          - **macOS**: `maratona_score-macOS-${{ github.ref_name }}.tar.gz`
          - **Windows**: `maratona_score-Windows-${{ github.ref_name }}.tar.gz`

          ### Installation
          1. Download the appropriate archive for your platform.
          2. Extract: `tar -xzf maratona_score-*.tar.gz`
          3. Run: `./maratona_score` (Linux/macOS) or `maratona_score.exe` (Windows).

          See [README.md](README.md) for full usage instructions.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}